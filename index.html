<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Pages Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* macOS 风格静态配色 - 浅色 (护眼蓝) */
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --bg-overlay: radial-gradient(circle at 10% 20%, rgba(216, 235, 255, 0.6) 0%, transparent 20%), 
                    radial-gradient(circle at 90% 80%, rgba(220, 210, 255, 0.6) 0%, transparent 20%);

      --glass-sidebar: rgba(255, 255, 255, 0.65);
      --glass-content: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(0, 0, 0, 0.05);
      
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      
      --input-bg: rgba(0, 0, 0, 0.03);
      --input-border: rgba(0, 0, 0, 0.1);
      --input-focus: #0071e3;
      
      --accent-color: #0071e3;
      --danger-color: #ff3b30;
      --success-color: #34c759;
      
      --shadow-window: 0 24px 48px rgba(0, 0, 0, 0.12);
      --radius-window: 18px;
      --radius-element: 10px;
    }

    [data-theme="dark"] {
      /* macOS 风格静态配色 - 深色 (午夜灰) */
      --bg-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
      --bg-overlay: radial-gradient(circle at 50% 0%, rgba(50, 70, 90, 0.4) 0%, transparent 60%);

      --glass-sidebar: rgba(40, 40, 40, 0.6);
      --glass-content: rgba(30, 30, 30, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);

      --text-primary: #f5f5f7;
      --text-secondary: #86868b;

      --input-bg: rgba(255, 255, 255, 0.08);
      --input-border: transparent;
      --input-focus: #2997ff;
      
      --accent-color: #2997ff;
      --shadow-window: 0 40px 80px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      /* 静态背景，不再闪烁 */
      background: var(--bg-gradient);
      position: relative;
      color: var(--text-primary);
      overflow: hidden;
    }
    
    /* 添加一层淡淡的光晕，增加质感但不刺眼 */
    body::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-overlay);
      pointer-events: none;
      z-index: 0;
    }

    /* 主窗口 */
    .app-window {
      width: 92%;
      max-width: 1100px;
      height: 85vh;
      max-height: 850px;
      display: flex;
      /* 强磨砂玻璃效果 */
      background: var(--glass-sidebar);
      backdrop-filter: blur(50px) saturate(180%);
      -webkit-backdrop-filter: blur(50px) saturate(180%);
      border-radius: var(--radius-window);
      box-shadow: var(--shadow-window);
      border: 1px solid var(--glass-border);
      position: relative;
      z-index: 10;
      overflow: hidden;
      flex-direction: row;
      opacity: 0;
      transform: scale(0.98);
      animation: openWindow 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    @keyframes openWindow {
      to { opacity: 1; transform: scale(1); }
    }

    /* 左侧边栏 */
    .sidebar {
      width: 280px;
      background: rgba(255,255,255,0.02); /* 极淡的叠加 */
      border-right: 1px solid var(--glass-border);
      padding: 28px 20px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    /* 右侧内容 */
    .content-area {
      flex: 1;
      background: var(--glass-content);
      padding: 40px 50px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* 品牌区 */
    .brand-area {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--glass-border);
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .brand-text {
      font-weight: 600;
      font-size: 18px;
      color: var(--text-primary);
    }

    /* 控件样式 */
    .control-group { margin-bottom: 16px; }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      padding-left: 2px;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      border-radius: var(--radius-element);
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      font-family: inherit;
      transition: all 0.2s;
    }
    
    input:focus, select:focus {
      background: var(--input-bg);
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
    }

    /* 侧边栏底部工具 */
    .sidebar-footer {
      margin-top: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 15px;
      border-top: 1px solid var(--glass-border);
    }

    .theme-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 5px;
      border-radius: 6px;
      transition: color 0.2s;
    }
    .theme-btn:hover { color: var(--text-primary); background: var(--input-bg); }

    /* 主内容标题 */
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
    }

    .content-header h2 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* 按钮系统 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    .btn:active { transform: scale(0.97); }

    .btn.primary {
      background: var(--accent-color);
      color: white;
    }
    .btn.primary:hover { filter: brightness(1.1); }
    
    .btn.secondary {
      background: var(--input-bg);
      color: var(--text-primary);
      border: 1px solid var(--input-border);
    }
    .btn.secondary:hover { background: rgba(128,128,128,0.1); }

    .btn.danger {
      background: rgba(255, 59, 48, 0.1);
      color: var(--danger-color);
    }
    .btn.danger:hover { background: var(--danger-color); color: white; }

    .btn.block { width: 100%; margin-top: 8px; padding: 10px; }

    /* 域名列表卡片 */
    .domain-card {
      background: var(--input-bg);
      border-radius: 12px;
      border: 1px solid var(--input-border);
      padding: 4px;
      min-height: 200px;
      margin-bottom: 30px;
    }

    .domain-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      margin-bottom: 2px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .domain-item:hover { background: rgba(128,128,128,0.08); }
    
    .status-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      margin-left: 10px;
    }
    .tag-active { background: rgba(52, 199, 89, 0.2); color: var(--success-color); }
    .tag-pending { background: rgba(255, 159, 10, 0.2); color: #FF9F0A; }

    /* 操作区网格 */
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .action-box {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      padding: 16px;
      border-radius: 12px;
    }

    .input-row { display: flex; gap: 8px; margin-top: 8px; }

    /* 日志区 */
    .terminal {
      background: #1e1e1e;
      color: #27c93f;
      padding: 16px;
      border-radius: 10px;
      font-family: 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.5;
      height: 120px;
      overflow-y: auto;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* 登录覆盖层 */
    .login-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-gradient);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-card {
      width: 320px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(40px);
      padding: 32px;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.2);
    }
    [data-theme="dark"] .login-card { background: rgba(40, 40, 40, 0.6); border-color: rgba(255,255,255,0.05); }

    .hidden { display: none !important; }
    .shake { animation: shake 0.4s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: rgba(30,30,30,0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 500;
      z-index: 200;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* 移动端适配 */
    @media (max-width: 768px) {
      .app-window { flex-direction: column; width: 100%; height: 100%; border-radius: 0; border: none; }
      .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--glass-border); padding: 20px; }
      .content-area { padding: 20px; }
      .action-grid { grid-template-columns: 1fr; }
      .brand-area { margin-bottom: 15px; }
    }
  </style>
</head>
<body>

  <div id="toast" class="toast">Message</div>

  <!-- 登录界面 -->
  <div id="loginScreen" class="login-overlay">
    <div class="login-card">
      <img src="https://image.hyeri.us.kg/icon.png" style="width:72px; height:72px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,0.15); margin-bottom:20px;">
      <h3 style="margin:0 0 8px;">Welcome Back</h3>
      <p style="color:var(--text-secondary); font-size:13px; margin:0 0 24px;">Please authenticate to continue</p>
      <input type="password" id="loginPassword" placeholder="Password" style="text-align:center; margin-bottom:16px;">
      <button id="loginBtn" class="btn primary block" style="height:40px;">Unlock</button>
      <div id="errorMsg" style="color:var(--danger-color); font-size:12px; margin-top:10px; opacity:0;">Incorrect Password</div>
    </div>
  </div>

  <!-- 主界面 -->
  <div id="mainScreen" class="app-window hidden">
    
    <!-- 左侧边栏 (Sidebar) -->
    <div class="sidebar">
      <div class="brand-area">
        <img src="https://image.hyeri.us.kg/icon.png" class="brand-icon">
        <div class="brand-text">Console</div>
      </div>

      <div style="flex:1; overflow-y:auto;">
        <div class="control-group">
          <label>ACCOUNT ID</label>
          <input id="accountId" placeholder="Account ID" />
        </div>
        <div class="control-group">
          <label>PAGES TOKEN</label>
          <input id="pagesToken" type="password" placeholder="API Token" />
        </div>
        <div class="control-group">
          <label>ZONE TOKEN</label>
          <input id="zoneToken" type="password" placeholder="API Token" />
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
          <button id="loadConfigBtn" class="btn secondary" style="flex:1;">Load</button>
          <button id="saveConfigBtn" class="btn primary" style="flex:1;">Save</button>
        </div>

        <hr style="border:0; border-top:1px solid var(--glass-border); margin:24px 0;">

        <div class="control-group">
          <label>SELECT PROJECT</label>
          <select id="projectSelect"><option value="">-- Select --</option></select>
          <button id="loadProjectsBtn" class="btn secondary block">Fetch Projects</button>
        </div>
      </div>

      <div class="sidebar-footer">
        <span style="font-size:12px; color:var(--text-secondary);">v2.0.1 Stable</span>
        <button id="themeToggle" class="theme-btn">◑</button>
      </div>
    </div>

    <!-- 右侧内容 (Content) -->
    <div class="content-area">
      <div class="content-header">
        <h2>Domain Manager</h2>
        <button id="refreshDomainsBtn" class="btn secondary">Refresh List</button>
      </div>

      <div id="domainList" class="domain-card">
        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-secondary); min-height:190px;">
          Waiting for project selection...
        </div>
      </div>

      <div class="action-grid">
        <div class="action-box">
          <label style="color:var(--accent-color);">ADD DOMAIN (AUTO DNS)</label>
          <div class="input-row">
            <input id="addDomainInput" placeholder="sub.example.com" />
            <button id="addDomainBtn" class="btn primary">Add</button>
          </div>
        </div>
        <div class="action-box">
          <label style="color:var(--danger-color);">REMOVE DOMAIN</label>
          <div class="input-row">
            <input id="removeDomainInput" placeholder="Domain to remove" />
            <button id="removeDomainBtn" class="btn danger">Remove</button>
          </div>
        </div>
      </div>

      <label>TERMINAL OUTPUT</label>
      <div id="output" class="terminal">System ready. Waiting for user input...</div>
    </div>
  </div>

  <script>
    // UI 交互逻辑
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    const toast = document.getElementById('toast');
    let toastTimer;

    // 主题切换
    themeToggle.addEventListener('click', () => {
      const current = html.getAttribute('data-theme');
      html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    });

    // Toast 提示
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // 登录错误动画
    function triggerError() {
      const err = document.getElementById('errorMsg');
      const card = document.querySelector('.login-card');
      err.style.opacity = 1;
      card.classList.remove('shake');
      void card.offsetWidth;
      card.classList.add('shake');
    }

    // --- 核心业务逻辑 (保持完全一致) ---
    const loginScreen=document.getElementById('loginScreen');
    const mainScreen=document.getElementById('mainScreen');
    const loginPassword=document.getElementById('loginPassword');
    const loginBtn=document.getElementById('loginBtn');

    async function checkLogin(){
      const password=loginPassword.value.trim();
      if(!password) return triggerError();
      try{
        const resp=await fetch('/api/auth',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({password})
        });
        const data=await resp.json();
        if(data.success){
          sessionStorage.setItem('authenticated','true');
          showMainScreen();
        }else{ triggerError(); }
      }catch(e){ triggerError(); }
    }

    function showMainScreen(){
      loginScreen.style.opacity = 0;
      setTimeout(() => {
        loginScreen.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        loadConfig();
      }, 300);
    }

    loginBtn.addEventListener('click',checkLogin);
    loginPassword.addEventListener('keypress',e=>{if(e.key==='Enter')checkLogin();});

    if(sessionStorage.getItem('authenticated')==='true'){
      loginScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      loadConfig();
    }

    // 变量声明
    const accountId=document.getElementById('accountId');
    const pagesToken=document.getElementById('pagesToken');
    const zoneToken=document.getElementById('zoneToken');
    const projectSelect=document.getElementById('projectSelect');
    const loadProjectsBtn=document.getElementById('loadProjectsBtn');
    const domainList=document.getElementById('domainList');
    const addDomainInput=document.getElementById('addDomainInput');
    const addDomainBtn=document.getElementById('addDomainBtn');
    const removeDomainInput=document.getElementById('removeDomainInput');
    const removeDomainBtn=document.getElementById('removeDomainBtn');
    const refreshDomainsBtn=document.getElementById('refreshDomainsBtn');
    const saveConfigBtn=document.getElementById('saveConfigBtn');
    const loadConfigBtn=document.getElementById('loadConfigBtn');
    const output=document.getElementById('output');

    async function apiCall(path,method='GET',body=null){
      output.innerHTML += `<div>> ${method} ${path}...</div>`;
      output.scrollTop = output.scrollHeight;
      try{
        const resp=await fetch(path,{
          method,
          headers:{
            'Content-Type':'application/json',
            'X-Account-Id':accountId.value.trim(),
            'X-Pages-Token':pagesToken.value.trim(),
            'X-Zone-Token':zoneToken.value.trim()
          },
          body:body?JSON.stringify(body):null
        });
        const data=await resp.json().catch(()=>({error:'Invalid Response'}));
        output.innerHTML += `<div style="color:${resp.ok?'#4cd964':'#ff3b30'}">> Result: ${data.success?'Success':'Fail'}</div>`;
        output.scrollTop = output.scrollHeight;
        return{ok:resp.ok,data};
      }catch(e){
        output.innerHTML += `<div style="color:#ff3b30">> Error: ${e.message}</div>`;
        return{ok:false,data:null};
      }
    }

    async function saveConfig(){
      const config={accountId:accountId.value.trim(),pagesToken:pagesToken.value.trim(),zoneToken:zoneToken.value.trim()};
      if(!config.accountId||!config.pagesToken||!config.zoneToken) return showToast('Please fill all fields');
      const res=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(config)});
      const data=await res.json();
      showToast(data.success?'Configuration Saved':'Save Failed');
    }

    async function loadConfig(){
      const res=await fetch('/api/config');
      const data=await res.json();
      if(data.success&&data.config){
        accountId.value=data.config.accountId||'';
        pagesToken.value=data.config.pagesToken||'';
        zoneToken.value=data.config.zoneToken||'';
        output.innerHTML += `<div>> Config loaded from server</div>`;
      }
    }

    async function loadProjects(){
      const acc=accountId.value.trim();
      if(!acc||!pagesToken.value.trim()) return showToast('Missing Credentials');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects`);
      if(res.ok&&res.data.success){
        const projects=res.data.result||[];
        projectSelect.innerHTML=projects.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
        if(projects.length>0){
          projectSelect.value=projects[0].name;
          await loadDomains();
        }
      }
    }

    async function loadDomains(){
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      if(!acc||!proj)return;
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains`);
      domainList.innerHTML='';
      if(res.ok&&res.data.success){
        const domains=res.data.result||[];
        if(domains.length===0){
          domainList.innerHTML='<div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--text-secondary);">No domains found</div>';
        }else{
          domains.forEach(d=>{
            const isAct = d.status==='active';
            const el=document.createElement('div');
            el.className='domain-item';
            el.innerHTML=`
              <div style="display:flex;align-items:center;">
                <span style="font-weight:500">${d.name}</span>
                <span class="status-tag ${isAct?'tag-active':'tag-pending'}">${isAct?'Active':'Verifying'}</span>
              </div>
              <button class="btn secondary" style="padding:4px 10px;font-size:12px;" onclick="confirmAndRemove('${encodeURIComponent(d.name)}')">Disconnect</button>
            `;
            domainList.appendChild(el);
          });
        }
      }
    }

    window.confirmAndRemove=async function(domainEncoded){
      const domain=decodeURIComponent(domainEncoded);
      if(!confirm(`Delete domain ${domain}?`))return;
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains/${domain}`,'DELETE');
      if(res.ok&&res.data.success){
        await loadDomains();
        showToast('Domain removed');
      } else {
        showToast('Remove failed');
      }
    };

    addDomainBtn.addEventListener('click',async()=>{
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const domain=addDomainInput.value.trim();
      if(!acc||!proj||!domain) return showToast('Check Inputs');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains`,'POST',{name:domain});
      if(res.ok&&res.data.success){
        addDomainInput.value='';
        await loadDomains();
        showToast(res.data.dns_created?'Domain & DNS Created':'Domain Added');
      } else { showToast('Add Failed'); }
    });

    removeDomainBtn.addEventListener('click',async()=>{
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const domain=removeDomainInput.value.trim();
      if(!acc||!proj||!domain) return showToast('Input Domain');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains/${domain}`,'DELETE');
      if(res.ok&&res.data.success){
        removeDomainInput.value='';
        await loadDomains();
        showToast('Domain Deleted');
      } else { showToast('Delete Failed'); }
    });

    refreshDomainsBtn.addEventListener('click',() => { loadDomains(); showToast('Refreshed'); });
    loadProjectsBtn.addEventListener('click',loadProjects);
    projectSelect.addEventListener('change',loadDomains);
    saveConfigBtn.addEventListener('click',saveConfig);
    loadConfigBtn.addEventListener('click',loadConfig);
  </script>
</body>
</html>
