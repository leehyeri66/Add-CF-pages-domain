<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloudflare Pages åŸŸåç®¡ç†</title>
  <style>
    body {
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:40px 10px;
    }
    .container {max-width:900px;margin:0 auto;}
    .header{text-align:center;margin-bottom:36px;color:white;}
    .header h1{font-size:32px;font-weight:700;margin-bottom:8px;}
    .header p{font-size:16px;}
    .card{background:white;border-radius:16px;padding:26px;margin-bottom:20px;box-shadow:0 6px 32px rgba(60,30,90,0.13);}
    .card-title{font-size:18px;font-weight:600;color:#333;margin-bottom:16px;}
    label{display:block;font-weight:500;margin-bottom:8px;color:#555;}
    input,select{width:100%;padding:12px 16px;border:2px solid #dedede;border-radius:8px;font-size:14px;}
    input:focus,select:focus{border-color:#764ba2;outline:none;}
    button{width:100%;padding:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;margin-top:10px;}
    button:hover{background:linear-gradient(135deg,#4a65d6 0%,#62447a 100%);}
    button.danger{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);}
    button.danger:hover{background:linear-gradient(135deg,#ab3b6c 0%,#f77062 100%);}
    button.secondary{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);}
    .flex-row{display:flex;gap:10px;}
    .domain-list{margin-top:16px;}
    .domain-item{background:#f9f8fb;border-radius:8px;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;margin-bottom:8px;box-shadow:0 2px 8px 0 #eee;}
    .domain-item span{color:#333}
    .domain-item button{width:auto;padding: 4px 16px;font-size:13px;margin-top:0;}
    .hidden{display:none;}
    pre{background:#1e1e1e;color:#eaeaea;padding:16px;border-radius:8px;overflow-x:auto;font-size:13px;}
    @media(max-width: 650px){.flex-row{flex-direction:column;}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>â˜ï¸ Cloudflare Pages è‡ªå®šä¹‰åŸŸåç®¡ç†</h1>
      <p>å®‰å…¨ç®¡ç†é¡¹ç›®åŸŸåç»‘å®š</p>
    </div>
    <div class="card">
      <label>Account ID <input type="text" id="accountId" placeholder="ä½ çš„ Cloudflare Account ID" /></label>
    </div>
    <div class="card hidden" id="projectSection">
      <div class="flex-row">
        <div style="flex:2">
          <label>é€‰æ‹© Pages é¡¹ç›®
            <select id="projectSelect"><option value="">-- å…ˆåŠ è½½é¡¹ç›® --</option></select>
          </label>
        </div>
        <div style="flex:1">
          <button id="loadProjectsBtn" class="secondary">ğŸ”„ åˆ·æ–°é¡¹ç›®</button>
        </div>
      </div>
    </div>
    <div class="card hidden" id="domainSection">
      <div class="card-title">å·²ç»‘å®šåŸŸå</div>
      <div id="domainList" class="domain-list"></div>
      <div class="flex-row" style="margin-top:22px;">
        <div style="flex:3">
          <input type="text" id="addDomainInput" placeholder="æ–°åŸŸåï¼Œå¦‚ example.com" />
        </div>
        <div style="flex:1">
          <button id="addDomainBtn">æ·»åŠ åŸŸå</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“¡ API å“åº”</div>
      <pre id="output">ç­‰å¾…æ“ä½œ...</pre>
    </div>
  </div>
  <script>
    const accountIdInput = document.getElementById('accountId');
    const projectSection = document.getElementById('projectSection');
    const domainSection = document.getElementById('domainSection');
    const projectSelect = document.getElementById('projectSelect');
    const loadProjectsBtn = document.getElementById('loadProjectsBtn');
    const domainList = document.getElementById('domainList');
    const addDomainInput = document.getElementById('addDomainInput');
    const addDomainBtn = document.getElementById('addDomainBtn');
    const output = document.getElementById('output');

    let domainsCache = [];
    let lastSelectedProject = '';

    accountIdInput.addEventListener('input', () => {
      if (accountIdInput.value.trim()) {
        projectSection.classList.remove('hidden');
      } else {
        projectSection.classList.add('hidden');
        domainSection.classList.add('hidden');
      }
    });

    async function apiCall(path, method = 'GET', body = null) {
      output.textContent = 'â³ è¯·æ±‚ä¸­...';
      try {
        const opts = { method, headers: { 'Content-Type': 'application/json' }};
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(path, opts);
        let data;
        try { data = await res.json(); } catch {
          data = { error: 'éæ³•å“åº”å†…å®¹', raw: await res.text() };
        }
        output.textContent = JSON.stringify(data, null, 2);
        return { ok: res.ok, data };
      } catch (e) {
        output.textContent = 'âŒ é”™è¯¯: ' + e.message;
        return { ok: false, data: null };
      }
    }

    async function loadProjects() {
      const accountId = accountIdInput.value.trim();
      if (!accountId) return alert('è¯·è¾“å…¥ Account ID');
      const result = await apiCall(`/api/accounts/${accountId}/projects`);
      if (result.ok && result.data.success) {
        const projects = result.data.result ?? [];
        projectSelect.innerHTML = projects.length === 0 ? '<option>æ²¡æœ‰é¡¹ç›®</option>' : projects.map(
          p => `<option value="${p.name}">${p.name}</option>`
        ).join('');
        projectSection.classList.remove('hidden');
        if (projects.length > 0) {
          projectSelect.value = projects[0].name;
          await loadDomains();
        }
      }
    }

    async function loadDomains() {
      const accountId = accountIdInput.value.trim();
      const projectName = projectSelect.value;
      if (!accountId || !projectName) { domainSection.classList.add('hidden'); return; }
      const result = await apiCall(`/api/accounts/${accountId}/projects/${projectName}/domains`);
      domainsCache = [];
      domainList.innerHTML = '';
      if (result.ok && result.data?.result) {
        domainsCache = result.data.result;
        if (domainsCache.length === 0) {
          domainList.innerHTML = '<div style="color:#777">æš‚æ— è‡ªå®šä¹‰åŸŸå</div>';
        } else {
          domainList.innerHTML = domainsCache.map(d =>
            `<div class="domain-item">
              <span>${d.name}</span>
              <button class="danger" onclick="removeDomain('${d.name}')">åˆ é™¤</button>
            </div>`
          ).join('');
        }
        domainSection.classList.remove('hidden');
      } else {
        domainSection.classList.add('hidden');
      }
    }

    projectSelect.addEventListener('change', loadDomains);
    loadProjectsBtn.addEventListener('click', loadProjects);
    addDomainBtn.addEventListener('click', addDomain);

    async function addDomain() {
      const accountId = accountIdInput.value.trim();
      const projectName = projectSelect.value;
      const domain = addDomainInput.value.trim();
      if (!accountId || !projectName || !domain) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      const result = await apiCall(`/api/accounts/${accountId}/projects/${projectName}/domains`, 'POST', { domain_name: domain });
      if (result.ok && result.data.success) {
        addDomainInput.value = '';
        await loadDomains();
        alert('âœ… åŸŸåæ·»åŠ æˆåŠŸ');
      }
    }

    window.removeDomain = async function(domain) {
      const accountId = accountIdInput.value.trim();
      const projectName = projectSelect.value;
      if (!accountId || !projectName || !domain) return alert('æ•°æ®é”™è¯¯');
      if (!confirm(`ç¡®å®šè¦åˆ é™¤åŸŸå ${domain} å—ï¼Ÿ`)) return;
      const result = await apiCall(`/api/accounts/${accountId}/projects/${projectName}/domains/${domain}`, 'DELETE');
      if (result.ok && result.data.success) {
        await loadDomains();
        alert('âœ… åˆ é™¤æˆåŠŸ');
      }
    };

    // è‡ªåŠ¨å¡«å……ä¸åŸŸåŒæ­¥
    accountIdInput.addEventListener('blur', loadProjects);

    // é¡µé¢åŠ è½½å®Œæˆè‡ªåŠ¨å°è¯•åŠ è½½
    window.addEventListener('DOMContentLoaded', () => {
      if(accountIdInput.value.trim()) loadProjects();
    });
  </script>
</body>
</html>
